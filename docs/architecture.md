# 아키텍처 명세서

## 개요
- 클라이언트: Flutter
- 위치: geolocator (포그라운드 스트림/백그라운드 단발 조회)
- 스케줄링: Android WorkManager(3분 디버그 OneOff 재스케줄). iOS는 별도 설계 필요
- 백엔드: Supabase(PostgREST, Auth)

## 주요 흐름
1) 포그라운드
- 10초 간격 + 10m distanceFilter로 위치 스트림 수신
- 매 업데이트 시 `AttendanceService.checkAttendance()` → `location_logs` 삽입

2) 백그라운드(테스트 모드)
- WorkManager로 3분마다 콜백 실행
- **로컬 세션 복원**: shared_preferences에서 저장된 refresh token으로 인증 상태 복원
- 현재 위치 1회 획득 → 출석 체크 시도 + `location_logs` 저장
- 버스트 저장: 이후 60초간 15초 간격으로 lastKnownPosition 또는 현재 위치로 추가 저장
- 다음 3분 후 OneOff 재등록 (토큰 전달 없이 로컬 저장소 활용)

## 인증/세션
### 기본 인증
- 기본: Supabase 세션 복구 시도(refresh)
- 실패 대비: access token 전달 → JWT 이메일 디코드 → `users` 매핑 후 저장 시도
- 향후: 내부 `user_id(int)` 포그라운드에서 캐시/전달하여 매핑 REST 제거

### 로컬 세션 관리 (shared_preferences)
- **AuthStorageService**: Flutter shared_preferences를 통한 로컬 세션 저장소
- **자동 로그인**: 앱 재시작 시 저장된 세션으로 자동 로그인 (7일 이내 로그인만 허용)
- **세션 유지**: 로그인 성공 시 세션 정보를 로컬에 자동 저장
- **세션 복원**: 앱 시작 시 저장된 세션 정보를 Supabase에 자동 복원
- **세션 삭제**: 로그아웃 시 로컬 세션 정보 함께 삭제
- **보안성**: 30일 이상 된 세션은 자동 삭제, 토큰 재사용 방지

### 세션 생명주기
1. **로그인**: `SupabaseService.signIn()` → 세션 정보 로컬 저장
2. **앱 시작**: `AuthWrapper._checkAutoLogin()` → 저장된 세션 확인 및 복원
3. **사용 중**: Supabase 내부 세션 관리 + 로컬 백업
4. **로그아웃**: `SupabaseService.signOut()` → 로컬 세션 삭제
5. **세션 만료**: 7일 자동 로그인 제한, 30일 세션 수명 제한

## 신뢰성 보강 계획
### 데이터 신뢰성
- 오프라인 큐(SQLite)로 오프라인에서도 누락 없이 적재 → 네트워크 복구 시 업로드
- 포그라운드 서비스 전환(상시 알림) 옵션으로 짧은 주기 보장

### 인증 신뢰성
- **로컬 세션 백업**: shared_preferences로 안정적인 세션 유지
- **자동 복구**: 네트워크 오류 시에도 로컬 세션으로 인증 유지
- **세션 갱신**: Supabase 자동 갱신 + 로컬 백업으로 이중 보호
- **오류 처리**: 세션 복원 실패 시 자동 삭제 및 재인도

## 안드로이드 제약
- Doze/App Standby/제조사 절전으로 짧은 주기 보장 어려움
- WorkManager 반복작업 15분 미만 보장 불가 → OneOff 대체

## 로그/진단
### 시스템 로그
- 권한/세션/DNS/위치/삽입결과를 `debugPrint`로 표준화하여 수집

### 인증 로그
- **세션 저장**: 로그인 성공 시 "로그인 성공 및 세션 저장 완료" 로그
- **세션 복원**: 앱 시작 시 "저장된 세션 복원 성공/실패" 로그
- **세션 삭제**: 로그아웃 시 "로그아웃 완료 및 로컬 세션 삭제" 로그
- **자동 로그인**: 자동 로그인 성공/실패 시 상세 로그 출력
- **백그라운드 세션**: "백그라운드: 저장된 세션으로 인증 복원 성공/실패" 로그

### 백그라운드 위치 추적 로그
- **세션 확인**: "백그라운드: 현재 사용자 세션 존재/없음" 로그
- **예배 시간 판단**: "백그라운드 로컬 시간 판단: 예배 시간/예배 시간 아님" 로그
- **교회 반경 확인**: "백그라운드 교회 반경 확인: 반경 내/반경 밖" 로그
- **위치 수집**: "백그라운드 위치 확인: 위도 X, 경도 Y" 로그
- **출석 체크**: "백그라운드 출석 체크 완료" 로그
- **위치 로깅**: "백그라운드 위치 로깅 성공/실패" 로그
- **큐 상태**: "백그라운드: 큐 상태 total=N eligible=M" 로그

