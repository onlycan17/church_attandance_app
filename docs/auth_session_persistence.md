# Auth Session Persistence - 개선 메모

목표: 앱에서 로그인이 장기간 안정적으로 유지되도록 하고, 백그라운드 워커가 세션을 깨뜨리지 않도록 보호한다.

## 배경
- 현재 `Supabase.initialize(url, anonKey)` 기본 사용. 일반적으로 세션 저장/자동 갱신은 기본 활성.
- 백그라운드 워커(`background_location_callback.dart`)에서 `setSession(refresh_token)`을 시도. 동일 refresh token 재사용은 Supabase 보안 정책(토큰 재사용 감지)에 의해 세션 전체가 폐기될 수 있음 → 사용자가 갑자기 로그아웃된 것처럼 보이는 현상 유발.

용어(설명):
- refresh token(설명: access token을 새로 받는 데 쓰는 긴 수명의 표. 같은 표를 반복 제출하면 부정 사용으로 간주되어 세션 폐기 가능)
- 비활성 시간 제한(설명: 일정 시간 동안 토큰 갱신이 없으면 세션 종료되는 타이머)
- 단일 세션(설명: 최신 로그인만 유지하고 과거 로그인은 강제로 종료)

## 문제 가설
1) 백그라운드에서 오래된 refresh token이 반복 사용되어 세션 전체가 폐기됨.
2) Supabase Auth 서버 설정(비활성 시간 제한, 세션 수명, 단일 세션)이 앱 패턴과 맞지 않음.

## 개선 방안(앱 측)
- 백그라운드에서 refresh token 기반의 세션 복구를 중단. 필요 시 최신 토큰 1회성 사용만 허용하되, 자동 재스케줄 시 토큰 전달 금지.
- access token은 이메일 디코딩 등 보조 용도로만 사용(데이터 쓰기는 오프라인 큐 우선).
- 진단 로그 강화(onAuthStateChange 이벤트/만료시각)를 개발 모드에서만 출력.

## 개선 방안(서버 설정 권장)
- 비활성 시간 제한: 충분히 길거나 비활성화(0)
- 세션 최장 수명(Time-box): 필요 시 넉넉하게, 아니면 비활성화
- 단일 세션 강제: 다중 디바이스/워커 동시 사용 시 OFF 권장
- JWT 만료: 너무 짧지 않게(권장 1시간)

## 작업 항목(TODO)
- [x] 백그라운드 `setSession(refresh_token)` 제거
- [x] 재스케줄 시 access/refresh token 전달 제거
- [ ] 서버 설정 점검(MCP: SUPABASE_ACCESS_TOKEN 필요)
- [ ] onAuthStateChange 상세 로그(개발 빌드 한정) 추가 여부 검토

## 검증 계획
- 앱 실행 유지 후 백그라운드 작업 반복 실행 시 세션 유지 확인
- 로그로 세션 만료/갱신 이벤트가 더 이상 예기치 않게 발생하지 않는지 확인
- 필요 시 서버 설정 완화 후 비교 테스트
